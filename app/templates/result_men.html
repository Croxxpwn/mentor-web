{% extends "base.html" %}
{% from 'macros.html' import user_block,user_block_detail,user_block_with_modal_appointment_new %}

{% block head %}
    <title>导师有约 —— 预约审批</title>
    <link href="/static/lib/css/bootstrap-datetimepicker.min.css" rel="stylesheet"/>
    <script src="/static/lib/js/bootstrap-datetimepicker.min.js"></script>
    <script type="text/javascript" src="/static/lib/js/locales/bootstrap-datetimepicker.zh-CN.js"
            charset="UTF-8"></script>
{% endblock %}

{% block content %}

    <div class="container">
        <div class="row">
            <div class="col-md-12">
                <div class="row">
                    <div class="col-md-12">
                        <h2>预约申请</h2>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-12">
                        <table class="table table-striped">
                            <thead>
                            <tr>
                                <th>学生ID</th>
                                <th>学生姓名</th>
                                <th>预约原因</th>
                                <th>申请时间</th>
                                <th>预约状态</th>
                                <th>回复</th>
                                <th>回复时间</th>
                                <th>开始时间</th>
                                <th>结束时间</th>
                                <th>预约地点</th>
                                <th>操作</th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for appointment in appointments %}
                                <tr>
                                    <td>{{ appointment.stu.id }}</td>
                                    <td>{{ appointment.stu.name }}</td>
                                    <td>{{ appointment.description }}</td>
                                    <td>{{ appointment.time_submit.strftime('%Y-%m-%d %H:%M') }}</td>
                                    <td>
                                        {% if appointment.status == 0 %}
                                            <span style="color: #006dcc">等待审核</span>
                                        {% elif appointment.status == 1 %}
                                            <span style="color: #5cb85c">通过</span>
                                        {% elif appointment.status ==2 %}
                                            <span style="color: #b92c28">拒绝</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if appointment.replytext %}
                                            {{ appointment.replytext }}
                                        {% else %}
                                            暂无数据
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if appointment.time_reply %}
                                            {{ appointment.time_reply.strftime('%Y-%m-%d %H:%M') }}
                                        {% else %}
                                            暂无数据
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if appointment.time_start %}
                                            {{ appointment.time_start.strftime('%Y-%m-%d %H:%M') }}
                                        {% else %}
                                            暂无数据
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if appointment.time_end %}
                                            {{ appointment.time_end.strftime('%Y-%m-%d %H:%M') }}
                                        {% else %}
                                            暂无数据
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if appointment.location %}
                                            {{ appointment.location }}
                                        {% else %}
                                            暂无数据
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if appointment.status == 0 %}
                                            <div class="btn btn-primary btn-sm" data-toggle="modal"
                                                 data-target="#modal-pass-{{ appointment.id }}">通过
                                            </div>
                                            <div class="btn btn-danger btn-sm" data-toggle="modal"
                                                 data-target="#modal-deny-{{ appointment.id }}">拒绝
                                            </div>
                                        {% else %}
                                        {% endif %}
                                    </td>

                                </tr>


                                <div class="modal fade" id="modal-pass-{{ appointment.id }}" tabindex="-1" role="dialog"
                                     aria-labelledby="modal-pass-{{ appointment.id }}-label"
                                     aria-hidden="true">
                                    <div class="modal-dialog">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <button type="button" class="close" data-dismiss="modal"
                                                        aria-hidden="true">
                                                    &times;
                                                </button>
                                                <h3 class="modal-title" id="modal-pass-{{ appointment.id }}-label">
                                                    审批通过
                                                </h3>
                                            </div>
                                            <div class="modal-body">

                                                <div class="row">
                                                    <div class="col-md-12">
                                                        <h4>回复信息</h4>
                                                        <textarea id="replytext_pass_{{ appointment.id }}"
                                                                  name="replytext" rows="6"
                                                                  class="form-control"></textarea><br/>
                                                    </div>
                                                </div>

                                                <div class="row">
                                                    <div class="col-md-12">
                                                        <h4>预约地点</h4>
                                                        <input id="location_pass_{{ appointment.id }}" name="location"
                                                               type="text" class="form-control"/><br/>
                                                    </div>
                                                </div>

                                                <div class="row">
                                                    <div class="col-md-12">
                                                        <h4>预约开始时间</h4>
                                                        <input id="time_start_pass_{{ appointment.id }}"
                                                               name="time_start"
                                                               type="text"
                                                               class="form-control"><br/>
                                                        <script type="text/javascript">
                                                            $("#time_start_pass_{{ appointment.id }}").datetimepicker({
                                                                format: "yyyy-mm-dd hh:ii",
                                                                autoclose: true,
                                                                todayBtn: true
                                                            });
                                                        </script>
                                                    </div>
                                                </div>

                                                <div class="row">
                                                    <div class="col-md-12">
                                                        <h4>预约结束时间</h4>
                                                        <input id="time_end_pass_{{ appointment.id }}" name="time_end"
                                                               type="text"
                                                               class="form-control"><br/>
                                                        <script type="text/javascript">
                                                            $("#time_end_pass_{{ appointment.id }}").datetimepicker({
                                                                format: "yyyy-mm-dd hh:ii",
                                                                autoclose: true,
                                                                todayBtn: true
                                                            });
                                                        </script>
                                                    </div>
                                                </div>

                                                <div class="row">
                                                    <div class="col-md-12">
                                                        <div class="btn btn-primary pull-right"
                                                             onclick="ajax_appointment_{{ appointment.id }}_pass()">提交
                                                        </div>
                                                    </div>
                                                </div>
                                                <script>
                                                    var csrftoken = "{{ csrf_token()|safe }}";

                                                    function ajax_appointment_{{ appointment.id }}_pass() {
                                                        $.ajax({
                                                            type: "POST",
                                                            url: "/ajax/appointment/{{ appointment.id }}/pass",
                                                            data: "replytext=" + $("#replytext_pass_{{ appointment.id }}").val()
                                                            + "&" + "location=" + $("#location_pass_{{ appointment.id }}").val()
                                                            + "&" + "time_start=" + $("#time_start_pass_{{ appointment.id }}").val()
                                                            + "&" + "time_end=" + $("#time_end_pass_{{ appointment.id }}").val(),
                                                            dataType: 'json',
                                                            async: false,
                                                            beforeSend: function (xhr, settings) {
                                                                xhr.setRequestHeader("X-CSRFToken", csrftoken)
                                                            },
                                                            error: function (request) {
                                                                alert("审批失败![网络错误]");
                                                            },
                                                            success: function (data) {
                                                                if (data.status == 20000) {
                                                                    alert("审批成功!");
                                                                    $('#modal-pass-{{ appointment.id }}').modal('hide');
                                                                } else {

                                                                    alert("审批失败![数据错误]");
                                                                }
                                                            }
                                                        });
                                                    }
                                                </script>

                                            </div>
                                        </div><!-- /.modal-content -->
                                    </div><!-- /.modal -->
                                </div>


                                <div class="modal fade" id="modal-deny-{{ appointment.id }}" tabindex="-1" role="dialog"
                                     aria-labelledby="modal-deny-{{ appointment.id }}-label"
                                     aria-hidden="true">
                                    <div class="modal-dialog">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <button type="button" class="close" data-dismiss="modal"
                                                        aria-hidden="true">
                                                    &times;
                                                </button>
                                                <h3 class="modal-title" id="modal-deny-{{ appointment.id }}-label">
                                                    审批通过
                                                </h3>
                                            </div>
                                            <div class="modal-body">

                                                <div class="row">
                                                    <div class="col-md-12">
                                                        <h4>回复信息</h4>
                                                        <textarea id="replytext_deny_{{ appointment.id }}"
                                                                  name="replytext" rows="6"
                                                                  class="form-control"></textarea><br/>
                                                    </div>
                                                </div>

                                                <div class="row">
                                                    <div class="col-md-12">
                                                        <div class="btn btn-primary pull-right"
                                                             onclick="ajax_appointment_{{ appointment.id }}_deny()">提交
                                                        </div>
                                                    </div>
                                                </div>
                                                <script>
                                                    var csrftoken = "{{ csrf_token()|safe }}";

                                                    function ajax_appointment_{{ appointment.id }}_deny() {
                                                        $.ajax({
                                                            type: "POST",
                                                            url: "/ajax/appointment/{{ appointment.id }}/deny",
                                                            data: "replytext=" + $("#replytext_deny_{{ appointment.id }}").val(),
                                                            dataType: 'json',
                                                            async: false,
                                                            beforeSend: function (xhr, settings) {
                                                                xhr.setRequestHeader("X-CSRFToken", csrftoken)
                                                            },
                                                            error: function (request) {
                                                                alert("审批失败![网络错误]");
                                                            },
                                                            success: function (data) {
                                                                if (data.status == 20000) {
                                                                    alert("审批成功!");
                                                                    $('#modal-deny-{{ appointment.id }}').modal('hide');
                                                                } else {

                                                                    alert("审批失败![数据错误]");
                                                                }
                                                            }
                                                        });
                                                    }
                                                </script>

                                            </div>
                                        </div><!-- /.modal-content -->
                                    </div><!-- /.modal -->
                                </div>

                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>
        </div>
    </div>


{% endblock %}